# - name: Install Nginx Ingress Controller
#   kubernetes.core.k8s:
#     state: present
#     definition: "{{ lookup('file', 'roles/ingress/templates/ingress.yaml') }}"


---
- name: Apply Nginx Ingress via manifest
  kubernetes.core.k8s:
    state: present
    definition: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: nginx-ingress-controller
        namespace: ingress-nginx
      spec:
        replicas: 2
        selector:
          matchLabels:
            app: nginx-ingress
        template:
          metadata:
            labels:
              app: nginx-ingress
          spec:
            containers:
            - name: controller
              image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.49.0
              args:
              - /nginx-ingress-controller
              ports:
              - containerPort: 80
              - containerPort: 443
- name: Expose service
  kubernetes.core.k8s:
    state: present
    definition: |
      apiVersion: v1
      kind: Service
      metadata:
        name: nginx-ingress
        namespace: ingress-nginx
      spec:
        type: LoadBalancer
        selector:
          app: nginx-ingress
        ports:
        - name: http
          port: 80
          targetPort: 80
        - name: https
          port: 443
          targetPort: 443
